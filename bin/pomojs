#!/usr/bin/env node
// vim:ft=javascript

global.cli   = require('commander');
var moment   = require('moment');
var Q        = require('q');
var util     = require('util');
var Helpers  = require('../lib/helpers');
var Landing  = require('../lib/reporters/landing');
var Tmux     = require('../lib/reporters/tmux');
var Logger   = require('../lib/reporters/logger');
var Speaker  = require('../lib/reporters/speaker');
var Runner   = require('../lib/runner');

Q.longStackSupport = true;

cli
  .usage('[reason]')
  .version(require('../package').version)
  .option('-w, --work [mins]', 'work timer length [25]', 25)
  .option('-b, --break [mins]', 'break timer length, 0 to disable [5]', 5)
  .option('-d, --duration [mins]', 'shortcut for -w <secs> -b 0', null)
  .option('-t, --tmux', 'enable tmux reporting')
  .option('-l, --log [file]', 'log to this file')
  .option('-q, --quiet', 'no sounds')
  .on('--help', function() {
    console.log('  examples:');
    console.log('');
    console.log('    $ pomojs                # start a timer');
    console.log('    $ pomojs "Fix stuff"    # reason');
    console.log('    $ pomojs -w 10          # 10-minute pomodoro');
    console.log('    $ pomojs -d 5 "Tea"     # Simple tea timer (no break)');
  })
  .parse(process.argv);

if (cli.duration) { cli.work = cli.duration; cli.break = 0; }

var pomo = new Runner(cli.work, cli.break, { reason: cli.args.join(' ') || 'work' });

if (cli.log) Logger.extend(pomo, cli.log);
if (cli.tmux) Tmux.extend(pomo);
Speaker.extend(pomo, { quiet: cli.quiet });
Landing.extend(pomo);

// ----------------------------------------------------------------------------
// Speaking / growling

pomo.run();
