#!/usr/bin/env node
global.cli  = require('commander');
var moment  = require('moment');
var Q       = require('q');
var util    = require('util');
var Helpers = require('../lib/helpers');
var Timer   = require('../lib/timer');
var Log     = require('../lib/log');

var speak    = Helpers.speak;
var growl    = Helpers.growl;
var c        = Helpers.c;
var indent   = Helpers.indent;
var clear    = Helpers.clear;
var copy     = Helpers.copy;
var exec     = Helpers.exec;
var duration = Helpers.duration;
var format   = util.format;

var work, snack;

Q.longStackSupport = true;

cli
  .option('-w, --work [n]', 'number of minutes to run [25]', 25)
  .option('-b, --break [n]', 'number minutes for a break [5]', 5)
  .option('-q, --quiet', 'no sounds')
  .parse(process.argv);

var reason = cli.args.join(' ') || 'do work';
var total  = { start: new Date(), end: null };

var say = function(words) {
  if (!cli.quiet) speak(words);
  growl(words);
};

Q.try(function() {
  work  = new Timer(cli.work,  { say: say });
  snack = new Timer(cli.break, { color: 32, say: say });

}).then(function() {
  clear();

  say(format("%s, %s work for %s", 
     moment().format("HH:mma"), work.duration.humanize(), reason));

  Log.now(format("time for %s (%s)\na %s break follows",
    reason, duration(work.duration), duration(snack.duration)));

  work.initial();
  return Q.delay(1000);

}).then(function() {
  return work.start();

}).then(function() {
  say(format("Done! %s, %s break",
    moment().format("HH:mma"), snack.duration.humanize()));

  Log.now(format("time for a break (%s)",
    duration(snack.duration)));

  snack.initial();
  return Q.delay(3000);

}).then(function() {
  total.end = new Date();
  return snack.start();

}).then(function() {
  say("All done!");
  Log.now("done");

}).done();

// -----

process.on('SIGINT', function() {
  console.log("");
  Log.now('interrupted');
  process.exit(0);
});
