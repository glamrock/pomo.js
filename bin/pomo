#!/usr/bin/env node
global.cli  = require('commander');
var helpers = require('../lib/helpers');
var Timer   = require('../lib/timer');
var Log     = require('../lib/log');
var moment  = require('moment');
var Q       = require('q');
Q.longStackSupport = true;

var speak    = helpers.speak;
var growl    = helpers.growl;
var c        = helpers.c;
var indent   = helpers.indent;
var clear    = helpers.clear;
var copy     = helpers.copy;
var exec     = helpers.exec;
var duration = helpers.duration;

cli
  .option('-w, --work [n]', 'number of minutes to run [25]', 25)
  .option('-b, --break [n]', 'number minutes for a break [5]', 5)
  .option('-q, --quiet', 'no sounds')
  .parse(process.argv);

var reason = cli.args.join(' ') || 'do work';
var total  = { start: new Date(), end: null };

var say = function(words) {
  if (!cli.quiet) speak(words);
  growl(words);
};

var work, snack;

Q.try(function() {
  work  = new Timer(cli.work,  { say: say });
  snack = new Timer(cli.break, { color: 32, say: say });

}).then(function() {
  say("" + moment().format("HH:mma") + ", " + work.duration.humanize() + " work for " + reason);

  clear();
  Log.now("time for " + reason + " (" + duration(work.duration) + ")");
  Log.line("a " + duration(snack.duration) + " break follows");
  console.log("");

  work.initial();
  return Q.delay(1000);

}).then(function() {
  return work.start();

}).then(function() {
  say("Done! " + moment().format("HH:mma") + ", " + snack.duration.humanize() + " break");

  Log.now("time for a break (" + duration(snack.duration) + ")");
  Log.line("");
  snack.initial();
  return Q.delay(3000);

}).then(function() {
  total.end = new Date();
  return snack.start();

}).then(function() {
  say("All done!");
  Log.now("done");

}).done();

// -----

process.on('SIGINT', function() {
  console.log("");
  Log.now('interrupted');
  process.exit(0);
});
