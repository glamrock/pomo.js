#!/usr/bin/env node
global.cli  = require('commander');
var helpers = require('../lib/helpers');
var Timer   = require('../lib/timer');
var Log     = require('../lib/log');
var moment  = require('moment');
var Q       = require('q');
Q.longStackSupport = true;

var speak    = helpers.speak;
var growl    = helpers.growl;
var c        = helpers.c;
var indent   = helpers.indent;
var clear    = helpers.clear;
var copy     = helpers.copy;
var exec     = helpers.exec;
var duration = helpers.duration;

cli
  .option('-w, --work [n]', 'number of minutes to run [25]', 25)
  .option('-b, --break [n]', 'number minutes for a break [5]', 5)
  .option('-q, --quiet', 'no sounds')
  .parse(process.argv);

var reason = cli.args.join(' ') || 'do work';
var total  = { start: new Date(), end: null };

var say = function(words) {
  if (!cli.quiet) speak(words);
  growl(words);
};

var work, snack;
var dot = ' â‹… ';

Q.try(function() {
  work  = new Timer(cli.work,  { say: say });
  snack = new Timer(cli.break, { color: 32, say: say });

}).then(function() {
  clear();
  Log.line("");
  Log.info(moment().format("HH:mma") + dot + "time for " + reason);
  Log.line(duration(work.duration) + " pomodoro (with " + duration(snack.duration) + " break)");
  console.log("");
  return work.start();

}).then(function() {
  say("Work done! Let's take a break");
  Log.line("");
  Log.info(moment().format("HH:mma") + dot + "time for a " + duration(snack.duration) + " break:");
  Log.line("");
  snack.initial();
  return Q.delay(3000);

}).then(function() {
  total.end = new Date();
  return snack.start();

}).then(function() {
  say("All done!");
  console.log("");
  Log.info("it's now " + moment().format("HH:mm"));

}).done();

// -----

process.on('exit', printLog);
process.on('SIGINT', function() { console.log(""); process.exit(0); });

// -----

function printLog() {
  var str = '';
  str += "  " + moment(total.start).format("HH:mm") + ": " + reason + "\n";
  if (total.end) str += "  " + moment(total.end).format("HH:mm") + ": # break\n";
  str += "  " + moment().format("HH:mm") + ": #";

  Log.line("");
  Log.info("time log (copied to clipboard):");
  console.log(c(32, indent(str, '  ')));
  copy(str);
}
